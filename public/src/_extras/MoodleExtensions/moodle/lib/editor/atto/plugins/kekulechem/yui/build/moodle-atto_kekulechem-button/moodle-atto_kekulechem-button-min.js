YUI.add("moodle-atto_kekulechem-button",function(e,t){var n=e.namespace("M.atto_kekulechem");n.Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{BTN_NAME_OBJ_INSERT:"kekuleChemObjInsert",CHEM_OBJ_INSERTER_CLASS:"KekuleChemObjInserter",CHEM_OBJ_VIEWER_CLASS:"KekuleChemObjViewer",CHEM_OBJ_TAGNAME:"img",initializer:function(){var e,t,l;this._preparingForSubmit=!1,l=this.get("attoKekulePluginPath")+"pix/icon.png",this.addButton({buttonName:this.BTN_NAME_OBJ_INSERT,iconurl:l,callback:this._execute,tags:"strike"}),this._addEssentialFiles(),e=this.get("host"),t=this,l=e.textarea.getDOMNode().form,"undefined"!=typeof Kekule&&(Kekule.X.domReady(function(){t._setEditorConfigs()}),Kekule.X.domReady(function(){t._prepareForDisplay()})),l.onsubmit=function(){t._prepareForSubmit()},e.on("change",function(){t._prepareForDisplay()})},_setEditorConfigs:function(){Kekule.Editor.ChemSpaceEditorConfigs&&Kekule.Editor.ChemSpaceEditorConfigs.getInstance&&Kekule.Editor.ChemSpaceEditorConfigs.getInstance().getInteractionConfigs().setAllowUnknownAtomSymbol(!1)},_getPurifyHtml:function(){var e=this.get("purifyHtml");return Kekule.StrUtils.strToBool(e)},_addEssentialFiles:function(){var e=this.get("kekuleCssUrl"),t=this.get("kekuleMoodleCssUrl");this._addCssUrl(e),this._addCssUrl(t)},_addCssUrl:function(e){var t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href",e),document.head.appendChild(t)},_prepareForDisplay:function(){var e,t,l;if("undefined"!=typeof Kekule&&!this._preparingForSubmit&&this._getPurifyHtml())for(t=(e=this._getEditorRootElem().getElementsByTagName(n.ChemObjDataWrapperUtils.CHEM_OBJ_WRAPPER_TAGNAME)).length-1;0<=t;--t)(l=e[t])&&Kekule.HtmlElementUtils.hasClass(l,n.ChemObjDataWrapperUtils.CHEM_OBJ_WRAPPER_CLASSNAME)&&n.ChemObjDataWrapperUtils.replaceDataWrappersWithImg(l)},_prepareForSubmit:function(){var e,t,l,a;if(this._getPurifyHtml()){this._preparingForSubmit=!0;try{for(t=(e=this._getEditorRootElem().getElementsByTagName(this.CHEM_OBJ_TAGNAME)).length-1;0<=t;--t)(l=e[t])&&Kekule.HtmlElementUtils.hasClass(l,this.CHEM_OBJ_VIEWER_CLASS)&&n.ChemObjDataWrapperUtils.replaceImgsWithDataWrapper(l);this.markUpdated()}finally{a=this,function(){a._preparingForSubmit=!1}.defer()}}else;},_getSelectedChemObjTarget:function(){var e=this.get("host"),t=e.getSelectedNodes(),e=e.getSelection()[0],l=[],a=this;return!e||e.collapsed?null:(t.some(function(e){var t=null,e=e.getDOMNode();if(e&&e.tagName&&(t=a._getParentChemObjElement(e,a._getEditorRootElem())),t&&(l.push(t),1<l.length))return!0}),1===l.length?l[0]:null)},_getEditorRootElem:function(){return this.get("host").editor.getDOMNode()},_getParentChemObjElement:function(e,t){return Kekule.HtmlElementUtils.hasClass(e,this.CHEM_OBJ_VIEWER_CLASS)||0<=(e.getAttribute("data-kekule-widget")||"").indexOf("ChemWidget.Viewer")?e:e!==t?this._getParentChemObjElement(e.parentNode,t):null},_execute:function(){var e=this._getSelectedChemObjTarget();this._targetElem=e||null,this._setEditorConfigs(),this._openDialog()},_openDialog:function(){var e,t,l,a;return this._inserterDialog||(this._inserterDialog=this._createDialog()),e=this._inserterDialog,l=this._targetElem?M.util.get_string("captionEditChemObj","atto_kekulechem"):M.util.get_string("captionAddChemObj","atto_kekulechem"),e.setCaption(l),this._targetElem?this._chemObjInserter.importFromElem(this._targetElem):this._chemObjInserter.setChemObj(null),t=null,(l=this.buttons[this.BTN_NAME_OBJ_INSERT])&&(t=l.getDOMNode()),a=this,e.openModal(function(e){e===Kekule.Widget.DialogButtons.OK&&a._submitChemObj()},t),this._forceInserterResize.bind(this).delay(),e},_forceInserterResize:function(){this._chemObjInserter.resized()},_createDialog:function(){var e,t=new Kekule.Widget.Dialog(document);return t.setButtons([Kekule.Widget.DialogButtons.OK,Kekule.Widget.DialogButtons.CANCEL]),(e=t.getClientElem()).style.minWidth="500px",e.style.minHeight="250px",(e=new Kekule.ChemWidget.ChemObjInserter(document)).setResizable(!0),e.getViewer().setEditorProperties({predefinedSetting:"fullFunc",commonToolButtons:null,chemToolButtons:null,allowCreateNewChild:!0}),e.appendToWidget(t),this._chemObjInserter=e,t},_submitChemObj:function(){var e=this._chemObjInserter,t=e.getExportImgElemAttributes();t["class"]||(t["class"]=""),t["class"]=" "+this.CHEM_OBJ_VIEWER_CLASS+" K-Transparent-Background",(e=this.get("host")).focus(),this._targetElem?Kekule.DomUtils.setElemAttributes(this._targetElem,t):(t=this._getNormalHtmlCode(t),e.insertContentAtFocusPoint(t)),this.markUpdated()},_getNormalHtmlCode:function(e){return this._generateElemHtmlCode(this.CHEM_OBJ_TAGNAME,null,e)},_generateElemHtmlCode:function(e,t,l){for(var a,r,i="<"+e,s=Kekule.ObjUtils.getOwnedFieldNames(l),n=0,o=s.length;n<o;++n)(a=s[n])&&(r=l[a],i+=" "+(a="className"===a?"class":a)+"='"+(r=r&&(r=(r=(r=(r=r.toString()).replace('/"/g',"&quot;")).replace("/'/g","&#039;")).replace("/</g","&lt;")).replace("/>/g","&gt;"))+"'");return i+=">",t&&(i+=t),i+="</"+e+">"},_generateHtmlElemsCode:function(e){var t,l,a,r=e.children||[],i=e.tagName,s=e.content||"",e=Object.extend({},e);for(delete e.tagName,delete e.content,delete e.children,t="",l=0,a=r.length;l<a;++l)t+=this._generateHtmlElemsCode(r[l]);return this._generateElemHtmlCode(i,s+t,e)}},{ATTRS:{kekuleCssUrl:{value:""},kekuleMoodleCssUrl:{value:""},attoKekulePluginPath:{value:""},purifyHtml:{value:!1}}}),n.ChemObjDataWrapperUtils={CHEM_OBJ_WRAPPER_TAGNAME:"span",CHEM_OBJ_DATA_TAGNAME:"span",CHEM_OBJ_IMG_TAGNAME:"img",CHEM_OBJ_WRAPPER_CLASSNAME:"Kekule-ChemObj-Wrapper",CHEM_OBJ_DATA_CLASSNAME:"Kekule-ChemObj-Wrapper-Data",CHEM_OBJ_IMG_CLASSNAME:"Kekule-ChemObj-Wrapper-Img",getWrapperDetails:function(e){var t,l,a,r,i;if(Kekule.HtmlElementUtils.hasClass(e,n.ChemObjDataWrapperUtils.CHEM_OBJ_WRAPPER_CLASSNAME)){if(t={},(l=Kekule.DomUtils.getDirectChildElems(e))&&l.length)for(a=0,r=l.length;a<r;++a)i=l[a],Kekule.HtmlElementUtils.hasClass(i,
n.ChemObjDataWrapperUtils.CHEM_OBJ_DATA_CLASSNAME)?t.dataElement=i:Kekule.HtmlElementUtils.hasClass(i,n.ChemObjDataWrapperUtils.CHEM_OBJ_IMG_CLASSNAME)&&(t.imgElement=i);e=t.dataElement||e,t.srcData=Kekule.DomUtils.getElementText(e);try{t.data=JSON.parse(t.srcData)}catch(s){}return t}return null},updateWrapperElem:function(e,t){var l,a=n.ChemObjDataWrapperUtils.getWrapperDetails(e);a&&(l=e.ownerDocument,a.dataElement||(Kekule.DomUtils.setElementText(e,""),a.dataElement=l.createElement(n.ChemObjDataWrapperUtils.CHEM_OBJ_DATA_TAGNAME),a.dataElement.className=n.ChemObjDataWrapperUtils.CHEM_OBJ_DATA_CLASSNAME,e.appendChild(a.dataElement)),a.imgElement||(a.imgElement=l.createElement(n.ChemObjDataWrapperUtils.CHEM_OBJ_IMG_TAGNAME),a.imgElement.className=n.ChemObjDataWrapperUtils.CHEM_OBJ_IMG_CLASSNAME,e.appendChild(a.imgElement))),Kekule.HtmlElementUtils.addClass(a.dataElement,KekuleMoodle.WidgetDataWrapper.WRAPPER_DATA_HTML_CLASS),Kekule.DomUtils.setElementText(a.dataElement,JSON.stringify(t)),Kekule.StyleUtils.setDisplay(a.dataElement,"none"),a=a.imgElement,t={width:t.width,height:t.height,style:t.style,src:t.src},Kekule.DomUtils.setElemAttributes(a,t),Kekule.HtmlElementUtils.addClass(e,KekuleMoodle.WidgetDataWrapper.WRAPPER_HTML_CLASS)},createWrapperElem:function(e,t){e=e.createElement(n.ChemObjDataWrapperUtils.CHEM_OBJ_WRAPPER_TAGNAME);return e.className=n.ChemObjDataWrapperUtils.CHEM_OBJ_WRAPPER_CLASSNAME,n.ChemObjDataWrapperUtils.updateWrapperElem(e,t),e},replaceDataWrappersWithImg:function(e){var t=n.ChemObjDataWrapperUtils.getWrapperDetails(e),l=Object.extend({dataWidget:t.widget},t.data),a=e.ownerDocument,t=e.parentNode,a=a.createElement("img");return Kekule.DomUtils.setElemAttributes(a,l),t.insertBefore(a,e),t.removeChild(e),a},replaceImgsWithDataWrapper:function(e){var t=e.ownerDocument,l=e.parentNode,a=Kekule.DomUtils.fetchAttributeValuesToJson(e),a=n.ChemObjDataWrapperUtils.createWrapperElem(t,a);return l.insertBefore(a,e),l.removeChild(e),a}}},"@VERSION@",{requires:["moodle-editor_atto-plugin","kekule","local_kekulejs","local_kekulejs/kekuleInitials"]});